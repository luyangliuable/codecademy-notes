# Race Condition Vulnerability

<!-- markdown-toc start - Don't edit this section. Run M-x markdown-toc-refresh-toc -->
**Table of Contents**

- [Race Condition Vulnerability](#race-condition-vulnerability)
    - [Time-of-check to Time-of-use race condition](#time-of-check-to-time-of-use-race-condition)
    - [Steps](#steps)
    - [Countermeasures](#countermeasures)

<!-- markdown-toc end -->


* Exploiting results being dependent on the order of processes to run malicious code.

## Time-of-check to Time-of-use race condition
A **software bug** that occurs when code checks the state of a resource such as a file or a network conneciton then uses that resource based on the previous state found.



## Steps
1. Previlaged user run code to edit /tmp/x file.
2. Context switch to the attacker's process and make /tmp/X point to a target such as /etc/passwd
3. Code runs and writes to /etc/passwd instead.


* Example of **Time-of-check to Time-of-use race condition** (TOCTTOU)
    * Process 1: Run the vulnerable program in a loop.
    * Process 2: Run attack program.
    * Time of Check: check for appropritate file access permission
    * Time of Use: the file is changed to point to /etc/passwd after the check was made.
    * Hence a exploit

```
          set-uid root                    Attacker program
     ----------------------------          ----------------
    | /tmp/x points  |           |        |                |
    | to an attacker |           |        |                |
    | owned file     v           |        |                |
    |                o access()  |        |                |
    |               /\           |        |                |
    |              |  |          |        |                |
    |   TOCTTOU -->|  \-------------------->  Make /tmp/X  |
    |   window     |             |        |   point to     |
    |               \            |        |   /etc/passwd  |
    |                o open()    |        |                |
    |                |           |        |                |
    |                |           |        |                |
    |                v           |        |                |
    |        write /etc/passwd   |        |                |
     ----------------------------          ----------------

```

## Countermeasures
* Enforce atomic operations
    * **Make check and use file one blocking operation**
    * e.g. f = open(file, O_CREAT | O_EXCL)
* Repeating Check and USe
    * To make it difficult for attacker to win the race condition
    * **Use access() more frequently**
* Stick symlink protection
    * Prevent creating symbolinks
```sh
sudo sysctl -w kernel.yama.protected_sticky_symlinks=1

sudo sysctl -w fs.protected_symlinks=1
```
* Principle of least privilege.
    * Include **only temporary previlages** within the vulnerable program
    * Prevent damage if race condition is won by the attacker.
